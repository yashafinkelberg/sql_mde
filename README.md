# sql_mde
Расчет MDE через SQL

## Стандартный расчет дисперсии через бакетирование:
Используем t-распределение для случаев с малым кол-вом бакетов (менее 200)

[общий пример расчета MDE](https://github.com/yashafinkelberg/sql_mde/blob/main/simple_mde.sql)

## Полное бакетирование:

Для wCR такой метод не подходит, так как метрика является сложной – много слагаемых, деление, умножение – сложно учесть все ковариации. Поэтому для wCR мы использовали полное бакетирование – то есть бакетирование всей метрики, а не отдельных компонент. Это позволяет честно измерять волатильность метрики, но при этом за счет того, что происходит полное бакетирование среднее колеблется от измерения к измерению. 


[пример полного бакетирования для wCR](https://github.com/yashafinkelberg/sql_mde/blob/main/full_bucketed_wcr_mde.sql)

## Почему иногда нужно брать менее 200 бакетов: 

Для wCR было проведено исследование по оптимальному кол-ву бакетов.
С одной стороны при увеличении кол-ва бакетов уменьшается коэффициент t-стастистика, с другой стороны при маленькой выборке растет дисперсия между бакетами.
Так для одной из вертикалей есть явный миниум на 30 бакетах: 

![image](https://github.com/user-attachments/assets/bd87bbff-2d39-4481-b80a-f06a19c85c27)

##  Проверка, что полное бакетирование дает адекватные результаты: 
Необходимо проверить, что такое бакетирование дает нормально распределение. Получаем распределение ниже, и проверяем на нормальность. 

[скрипт проверки такого расчета статистик](https://github.com/yashafinkelberg/sql_mde/blob/main/full_bucketed_wcr_mde_check.sql)

## CUPED
Как можно использовать CUPED:

[Пример реализации CUPED](https://github.com/yashafinkelberg/sql_mde/blob/main/CUPED_mde.sql)
